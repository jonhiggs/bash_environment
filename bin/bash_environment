#!/usr/bin/env bash
_usage() {
  echo "$0 [name[=value] ...]"
}

_uniq_actions() {
  [[ $( (for a in $@; do echo "$a"; done) | sort | uniq | wc -l) -eq 1 ]]
  return $?
}

_get_action() {
  [[ $1 =~ ^[^=]+$ ]] && echo "getter"  && return 0
  [[ $1 =~ ^.+=.+$ ]] && echo "setter"  && return 0
  return 1
}

_delete_variable() {
  gsed -i "/^$1=.*$/d" ${ENV_FILE}
}

readonly ENV_FILE="${HOME}/.bash_environment"
[[ -f "${ENV_FILE}" ]] || touch "${ENV_FILE}"
[[ $# -eq 0 ]] && cat ${ENV_FILE} && exit 0

actions=()
for arg in $@; do actions+=("$(_get_action ${arg})"); done
_uniq_actions ${actions[@]} || ( _usage && exit 1 )

for arg in $@; do
  key=$(echo ${arg} | cut -d= -f1)
  value=$(echo ${arg} | cut -d= -f2)

  case $(_get_action ${arg}) in
    "getter") grep -E "^$key=.+$" ${ENV_FILE} ;;
    "setter")
      _delete_variable ${key}
      echo "${arg}" >> ${ENV_FILE}
      ;;
  esac
done
